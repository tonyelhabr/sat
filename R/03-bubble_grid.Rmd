---
params:
  eval_slow: false
title: ""
author: "Tony"
date: ""
output:
  html_document:
    toc: true
    df_print: tibble
---

```{r setup, include = FALSE}
knitr::opts_knit$set(root.dir = rprojroot::find_rstudio_root_file())
knitr::opts_chunk$set(
  echo = TRUE,
  # cache = TRUE,
  cache = FALSE,
  include = FALSE,
  fig.align = "center",
  results = "hide",
  fig.width = 6,
  fig.height = 6,
  # out.width = 6,
  # out.height = 6,
  warning = FALSE,
  message = FALSE
)
options(scipen = 1, digits = 2)
```

Two awesome things inspired this post:

+ [`{ggplot2}`'s version 3.0 release](https://www.tidyverse.org/articles/2018/07/ggplot2-3-0-0/)
on [CRAN](https://cran.r-project.org/), including full support for the 
`{sf}` package and new functions `geom_sf()` and `coord_sf()`, which
make plotting data from shapefiles very straightforward.

+ [Jonas Scholey's blog post](http://jschoeley.github.io/2018/06/30/bubble-grid-map.html)
discussing the use of "bubble grid" maps as an alternative to
[chlorepath](https://en.wikipedia.org/wiki/Choropleth_map) maps, which
seem to be used more prevalent.

As Jonas implies, using color as a visual encoding is not always the best option,
a notion with which I strongly agree. [Cartograms](https://en.wikipedia.org/wiki/Cartogram)
try to address the ambiguity of color encoding with distortion of land area/distance,
but I think the result can be difficult to interpret. Bubble grid maps
seem to me to be an interesting alternative that can potentially display
information in a more direct manner.

With that being said, I decided to adapt Jonas' code to visualize
the Texas high school SAT/ACT data that I've looked at in other posts.
To simplify the visual encoding of information,
I'll filter the data down to a single 
statistic---the math test scores for the SAT for the year 2015.
(For other applications, the statistic might be population density, average median household income, etc.)
For the geo-spatial data,
I downloaded the shapefiles
for [schools](https://schoolsdata2-tea-texas.opendata.arcgis.com/datasets/059432fd0dcb4a208974c235e837c94f_0) and
[counties](https://schoolsdata2-tea-texas.opendata.arcgis.com/datasets/c71146b6426248a5a484d8b3c192b9fe_0)
provided by the [Texas Education Agency](https://tea.texas.gov/) (TEA).
Additionally,
I downloaded a shapefile for [Texas highways](http://hub.arcgis.com/datasets/e661b4004aee4c939569a563b6bb881a_0),
provided by the [Texas Department of Transportation](https://www.txdot.gov/)
(TxDOT). By plotting the major roadways in the state, the locations
of "sparsely" populated areas should be evident, which can explain
why there doesn't appear to any data in some regions. Finally, I'll
also use the Texas state and county border data provided in the `ggplot2::map_data()`
(which is essentially just serves as a wrapper for extracting
data provided in the `{maps}` package).

```{r packages, include = TRUE}
library("tidyverse")
library("teplot")
library("sf")
```

```{r config, include = FALSE}
config <-
  list(
    export_data = TRUE,
    dir_data = "data",
    export_viz = TRUE,
    dir_viz = "figs"
  )
```

```{r schools_raw_sf, eval = params$eval_slow}
schools_raw_sf <-
  file.path("data-raw", "Current_Schools") %>%
  sf::read_sf() %>%
  janitor::clean_names()
```

```{r schools_sf, eval = params$eval_slow}
schools_sf <-
  schools_raw_sf %>%
  mutate_at(vars(district, campus, county, region, gradegrp), funs(as.integer)) %>%
  rename(
    district_num = district,
    school_num = campus,
    county_num = county,
    region_num = region,
    grade_grp_num = gradegrp
  ) %>%
  rename(
    school = campname,
    district = distname,
    county = cntyname
  ) %>%
  mutate_at(vars(school, district, county, city), funs(toupper)) %>%
  mutate_at(vars(county), funs(str_remove_all(., "\\s+COUNTY"))) %>%
  mutate_at(vars(school), funs(str_remove_all(., "([H]\\s*[S]$)|(\\s+\\&)") %>% str_trim())) %>%
  select(
    school_num,
    school,
    district,
    city,
    county,
    region_num,
    grade_grp = graderange,
    grade_grp_num,
    instr_type,
    magnet,
    geometry
  )
```


```{r path_schools_sf}
path_schools_sf <- 
  file.path(config$dir_data, "schools_sf.shp")
```

```{r schools_sf_export, eval = params$eval_slow}
schools_sf %>% 
  st_write(path_schools_sf, delete_dsn = TRUE)
```

```{r schools_sf_import}
schools_sf <-
  st_read(path_schools_sf)
```


```{r counties_raw_sf, eval = params$eval_slow}
counties_raw_sf <-
  file.path("data-raw", "Counties") %>%
  sf::read_sf() %>%
  janitor::clean_names()
```

```{r counties_sf, eval = params$eval_slow}
counties_sf <-
  counties_raw_sf %>%
  mutate(county = fename %>% toupper()) %>%
  select(county, geometry)
counties_sf
```

```{r path_counties_sf}
path_counties_sf <- 
  file.path(config$dir_data, "counties_sf.shp")
```

```{r counties_sf_export, eval = params$eval_slow}
counties_sf %>% 
  st_write(path_counties_sf, delete_dsn = TRUE)
```

```{r counties_sf_import}
counties_sf <-
  st_read(path_counties_sf)
```

```{r hwys_sf_raw, eval = params$eval_slow}
hwys_sf_raw <-
  file.path("data-raw", "TxDOT_Memorial_Highways") %>%
  sf::read_sf() %>%
  janitor::clean_names()
hwys_sf_raw
```

```{r hwys_sf, eval = params$eval_slow}
hwys_sf_n_us <-
  hwys_sf_raw %>%
  as.data.frame() %>%
  dplyr::select(-geometry) %>%
  filter(rte_prfx == "US") %>%
  count(memorial_h, sort = TRUE)

hwys_sf <-
  hwys_sf_raw %>% 
  inner_join(hwys_sf_n_us)
hwys_sf
```

```{r path_hwys_sf}
path_hwys_sf <- 
  file.path(config$dir_data, "hwys_sf.shp")
```

```{r hwys_sf_export, eval = params$eval_slow}
hwys_sf %>% 
  st_write(path_hwys_sf, delete_dsn = TRUE)
```

```{r hwys_sf_import}
hwys_sf <-
  st_read(path_hwys_sf)
```

```{r schools_tea}
schools_tea <-
  teproj::import_ext_csv(
    schools_tea,
    dir = config$dir_data
  )

schools_tea_filt <-
  schools_tea %>%
  filter(year == 2015) %>%
  filter(test == "SAT") %>%
  rename(value = math)
```

```{r tx_border}
tx_border <- 
  teplot::get_map_data_state(state = "tx") %>% 
  as_tibble()
```

I'll skip over the data collection and cleaning steps and show the "final"
data.frames that I'm using.

```{r sf_show, results = "markup", include = TRUE}
schools_tea_filt
schools_sf
schools_sf
hwys_sf
tx_border
```

Here I create the grid of data that I'll use for the visual. (Thanks
to Jonas for [his example](http://jschoeley.github.io/2018/06/30/bubble-grid-map.html).)

```{r schools_grid, include = TRUE, eval = params$eval_slow}
counties_grid_sf <-
  counties_sf %>%
  st_make_grid(n = c(50, 50))

schools_grid_sf <-
  counties_sf %>%
  left_join(schools_tea_filt) %>%
  select(value) %>%
  st_interpolate_aw(to = counties_grid_sf, extensive = TRUE) %>%
  st_centroid() %>%
  cbind(st_coordinates(.))
```

```{r path_schools_grid_sf}
path_schools_grid_sf <- 
  file.path(config$dir_data, "schools_grid_sf.shp")
```

```{r schools_grid_sf_export, eval = params$eval_slow}
schools_grid_sf %>% 
  st_write(path_schools_grid_sf, delete_dsn = TRUE)
```

```{r schools_grid_sf_import}
schools_grid_sf <-
  st_read(path_schools_grid_sf)
```

```{r schools_grid_sf_show, include = TRUE, results = "markup"}
schools_grid_sf
```

```{r viz_schools_grid, include = TRUE, results = "asis"}
viz_schools_grid <-
  schools_grid_sf %>%
  ggplot() +
  geom_polygon(
    data = tx_border,
    ggplot2::aes(x = long, y = lat, group = group),
    color = "black",
    fill = NA
  ) +
  geom_sf(
    data = hwys_sf,
    linetype = "solid",
    size = 0.1,
    fill = "gray90"
  ) +
  coord_sf(datum = NA) +
  geom_point(
    aes(x = X, y = Y, size = value, fill = value),
    shape = 21,
    color = "black",
    show.legend = FALSE
  ) +
  scale_size_area(max_size = 8) +
  scale_fill_viridis_c() +
  teplot::theme_map() +
  labs(
    title = str_wrap("Texas High School Math SAT Scores, 2015", 80),
    caption = "By Tony ElHabr."
  )
viz_schools_grid
```

```{r viz_schools_grid_export}
teproj::export_ext_png(
  viz_schools_grid,
  export = config$export_viz,
  dir = config$dir_viz,
  units = "in",
  height = 8,
  width = 8
)
```
